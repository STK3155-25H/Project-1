
\begin{figure}[H]
\centering
\begin{tikzpicture}
\begin{axis}[
  width=9.5cm, height=7.2cm,
  xmode=log, log basis x=10,
  xlabel={Fit time (ms, log scale)},
  ylabel={$R^2$ (test)},
  title={Accuracy--Speed Pareto (per method \& degree)},
  grid=both, legend pos=south east,
  xmin=5e-2, xmax=5e2,
  ymin=-0.05, ymax=1.02,
  y tick label style={/pgf/number format/fixed,/pgf/number format/precision=2},
]

% Load once
\pgfplotstableread[col sep=comma, trim cells]{../outputs/benchmarks/tables/benchmarks.csv}\bench
% Sort ONCE by degree so lines per method connect successive degrees
\pgfplotstablesort[sort key=degree]{\benchD}{\bench}

% ---------- POINTS: color-by-method (robust, no filtering) ----------
\addplot[
  only marks,
  mark=*,
  mark size=2.2pt,
  scatter,
  scatter src=explicit symbolic,
  scatter/classes={
    ols={mark=*,draw=blue,fill=blue},
    ridge={mark=*,draw=orange,fill=orange},
    gd-vanilla={mark=*,draw=green!60!black,fill=green!60!black},
    gd-momentum={mark=*,draw=red,fill=red},
    gd-adam={mark=*,draw=purple,fill=purple}
  },
]
table[
  x=fit_time_ms,
  y=r2_test,
  meta=method,
  col sep=comma
]{\bench};

% ---------- DEGREE LABELS (small gray near each point) ----------
\addplot[
  only marks,
  mark size=0pt,
  nodes near coords,
  every node near coord/.style={
    font=\scriptsize\color{gray!80},
    anchor=south west,
    /pgf/number format/fixed,
  },
  point meta=explicit symbolic,
]
table[
  x=fit_time_ms,
  y=r2_test,
  meta=degree,
  col sep=comma
]{\bench};

% ---------- LINES: one explicit plot per method, from degree-sorted table ----------
% OLS
\addplot+[smooth, very thick, mark=none, color=blue, opacity=0.55]
  table[
    x=fit_time_ms, y=r2_test, col sep=comma, trim cells,
    row predicate/.code={%
      \pgfplotstablegetelem{\pgfplotstablerow}{method}\of{\benchD}%
      \edef\thismethod{\pgfplotsretval}%
      \IfStrEq{\thismethod}{ols}{}{ \pgfplotstableuserowfalse }%
    },
  ]{\benchD};

% Ridge
\addplot+[smooth, very thick, mark=none, color=orange, opacity=0.55]
  table[
    x=fit_time_ms, y=r2_test, col sep=comma, trim cells,
    row predicate/.code={%
      \pgfplotstablegetelem{\pgfplotstablerow}{method}\of{\benchD}%
      \edef\thismethod{\pgfplotsretval}%
      \IfStrEq{\thismethod}{ridge}{}{ \pgfplotstableuserowfalse }%
    },
  ]{\benchD};

% GD vanilla
\addplot+[smooth, very thick, mark=none, color=green!60!black, opacity=0.55]
  table[
    x=fit_time_ms, y=r2_test, col sep=comma, trim cells,
    row predicate/.code={%
      \pgfplotstablegetelem{\pgfplotstablerow}{method}\of{\benchD}%
      \edef\thismethod{\pgfplotsretval}%
      \IfStrEq{\thismethod}{gd-vanilla}{}{ \pgfplotstableuserowfalse }%
    },
  ]{\benchD};

% GD momentum
\addplot+[smooth, very thick, mark=none, color=red, opacity=0.55]
  table[
    x=fit_time_ms, y=r2_test, col sep=comma, trim cells,
    row predicate/.code={%
      \pgfplotstablegetelem{\pgfplotstablerow}{method}\of{\benchD}%
      \edef\thismethod{\pgfplotsretval}%
      \IfStrEq{\thismethod}{gd-momentum}{}{ \pgfplotstableuserowfalse }%
    },
  ]{\benchD};

% GD Adam
\addplot+[smooth, very thick, mark=none, color=purple, opacity=0.55]
  table[
    x=fit_time_ms, y=r2_test, col sep=comma, trim cells,
    row predicate/.code={%
      \pgfplotstablegetelem{\pgfplotstablerow}{method}\of{\benchD}%
      \edef\thismethod{\pgfplotsretval}%
      \IfStrEq{\thismethod}{gd-adam}{}{ \pgfplotstableuserowfalse }%
    },
  ]{\benchD};

% Legend (matches point colors)
\addlegendimage{mark=*,only marks,draw=blue,fill=blue}
\addlegendentry{ols}
\addlegendimage{mark=*,only marks,draw=orange,fill=orange}
\addlegendentry{ridge}
\addlegendimage{mark=*,only marks,draw=green!60!black,fill=green!60!black}
\addlegendentry{gd-vanilla}
\addlegendimage{mark=*,only marks,draw=red,fill=red}
\addlegendentry{gd-momentum}
\addlegendimage{mark=*,only marks,draw=purple,fill=purple}
\addlegendentry{gd-adam}

\end{axis}
\end{tikzpicture}
\caption{Accuracy--speed Pareto by method (color), with degree labels. Lines connect successive degrees per method (table pre-sorted by degree).}
\label{fig:pareto_r2_time_allinone}
\end{figure}